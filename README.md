<p align="center">
  <img src="docs/images/facturx_en.png"
       alt="Factur-X invoicing workflow diagram â€” CSV processing to PDF generation with embedded XML"
       width="1200">
</p>

> ğŸ‡¬ğŸ‡§ English | [ğŸ‡«ğŸ‡· FranÃ§ais](./README_FR.md)

![License](https://img.shields.io/badge/License-LICENSE.md-lightgreen.svg)
![PHP](https://img.shields.io/badge/PHP-CLI-777BB4?style=flat)
![Automation](https://img.shields.io/badge/Type-Automation-0095b1?style=flat)
![Factur-X](https://img.shields.io/badge/Invoice-Factur--X-151b1c?style=flat)

<p align="center">
  <a href="https://palks-studio.com">
    <img src="https://img.shields.io/badge/Palks%20Studio-Website-0095b1?style=for-the-badge" />
  </a>
  &nbsp;
  <a href="https://comeup.com/fr/@palksstudio">
    <img src="https://img.shields.io/badge/ComeUp-Profile-FFC400?style=for-the-badge" />
  </a>
</p>


# Palks Studio â€” Automation System
**Financial automation built for rigor, traceability, and longevity**

> This repository is a technical presentation and documentation repository.  
> It does not contain downloadable source code or production files.

This README documents design principles and system architecture.  
It intentionally avoids operational procedures and sensitive details.

---

## Overview

This repository presents a financial automation system designed to handle:  

- invoice generation (single & batch)  
- revenue tracking  
- payment reconciliation  
- client balances  
- accounting-ready exports

The system is deterministic, auditable, and explicit by design.

It operates:  

- without a database  
- without a CMS  
- without a SaaS dependency  
- without any exposed web interface

All executions run server-side, via CLI scripts and cron, with a strict separation of responsibilities.

This project is not a product, not a SaaS, and not a plug-and-play tool.  
It documents a production-grade approach to financial automation.

Over time, the engine has been progressively extended  
to cover real-world business cases,  
without compromising its original design principles.

The billing system now supports:  

- multi-line invoices  
- multiple VAT rates per invoice  
- complex or extended service periods  
- multi-month billing scenarios  
- complex combinations while remaining EN16931 Comfort compliant

This functional expansion did not alter  
the deterministic, auditable, and traceable nature of the system.

### Electronic invoicing (Factur-X)

The system natively integrates Factur-X electronic invoicing (hybrid PDF with embedded XML),  
in compliance with the European EN 16931 standard (Comfort profile):  

- generation of a semantically EN 16931-compliant Factur-X XML  
- XML validation (XSD and Schematron)  
- injection of the XML into the PDF  
- production of a single final document: the Factur-X hybrid PDF  
- direct integration into the `run.php` and `run_batch.php` pipelines  
- no parallel formats  
- no persistent XML storage

The system targets business compliance and e-invoicing interoperability (France / EU).  
PDF/A compliance (document archiving) is not a functional objective of the project and is deliberately out of scope.

Factur-X is handled as a native component of the engine,  
not as an external or optional module.

---

## Project structure

```
automation_finance/
â”‚
â”œâ”€â”€ engine/
â”‚   â”œâ”€â”€ build_facturx_xml.php         â†’ Factur-X XML generation
â”‚   â”œâ”€â”€ build_json.php                â†’ Client onboarding JSON builder
â”‚   â”œâ”€â”€ inject_facturx.py             â†’ Factur-X XML injection into PDF
â”‚   â”œâ”€â”€ run.php                       â†’ Main automation engine (cron / CLI)
â”‚   â”œâ”€â”€ run_batch.php                 â†’ Batch automation engine for client invoicing
â”‚   â”œâ”€â”€ billing_rules.php             â†’ Billing rules and dynamic pricing logic
â”‚   â”œâ”€â”€ alerts.php                    â†’ Execution alerts and notifications handling
â”‚   â”œâ”€â”€ import_csv.php                â†’ Client CSV import and validation handler
â”‚   â”œâ”€â”€ mailer.php                    â†’ Email sender with invoice attachment
â”‚   â”œâ”€â”€ mail_signature.php            â†’ Palks Studio signature
â”‚   â”œâ”€â”€ vendor/                       â†’ PHP dependencies (e.g. DomPDF)
â”‚   â””â”€â”€ templates/                    â†’ Invoices PDF template (bilingual FR / EN)
â”‚
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ logs/                         â†’ Execution logs per client
â”‚   â”œâ”€â”€ onboarding/                   â†’ JSON files generated by the client onboarding form
â”‚   â”œâ”€â”€ onboarding_done/              â†’ Processed onboarding JSON archived after build
â”‚   â”œâ”€â”€ archive_batch/                â†’ Archived client CSV
â”‚   â”œâ”€â”€ batch_sent/                   â†’ Zip sent
â”‚   â”œâ”€â”€ usage/                        â†’ Monthly client usage tracking
â”‚   â”œâ”€â”€ revenues/                     â†’ Cumulative revenues (internal accounting source)
â”‚   â”œâ”€â”€ payments/                     â†’ Payments received from the client (bank transfers, actually received amounts)
â”‚   â”œâ”€â”€ balance/                      â†’ Client accounting balance (invoiced vs paid, paid / unpaid status)
â”‚   â”œâ”€â”€ invoices/                     â†’ Invoices from the main activity (direct invoicing, internal use)
â”‚   â”œâ”€â”€ invoices_batch/               â†’ Invoices generated as part of the batch service (end clients)
â”‚   â”œâ”€â”€ inbox_batch/                  â†’ Client-provided CSV file (batch invoicing source)
â”‚   â”œâ”€â”€ counters/                     â†’ Annual invoice counter per client (direct invoicing)
â”‚   â””â”€â”€ counters_batch/               â†’ Annual invoice counter per client (batch invoicing)
â”‚
â”œâ”€â”€ tools/
â”‚   â”œâ”€â”€ update_balances.php           â†’ Updates client balances based on revenues and payments
â”‚   â”œâ”€â”€ find_client.php               â†’ Client lookup utility
â”‚   â”œâ”€â”€ build_client.php              â†’ Client email index builder
â”‚   â”œâ”€â”€ send_paid_receipts.php        â†’ Automatic sending of paid client receipts
â”‚   â”œâ”€â”€ purge_log.php                 â†’ Cleanup Script
â”‚   â”œâ”€â”€ client_project.php            â†’ CLI script aggregating and exporting client data by identifier
â”‚   â”œâ”€â”€ recettes_year.php             â†’ Export actually received revenues for a full year
â”‚   â”œâ”€â”€ recettes_month.php            â†’ Export actually received revenues for a given month
â”‚   â””â”€â”€ revenues_csv.php              â†’ Export revenues to a CSV file (accounting)
â”‚
â”œâ”€â”€ exports/
â”‚   â”œâ”€â”€ recettes/                     â†’ Monthly CSV exports generated on demand / Yearly CSV exports generated on demand
â”‚   â””â”€â”€ payments/                     â†’ CSV generated from the received payments JSON files
â”‚
â”œâ”€â”€ downloads/                        â†’ Monthly ZIP archives per client, containing automatically generated PDF invoices
â”œâ”€â”€ clients/                          â†’ Client configuration file (only file to edit per client)
â”œâ”€â”€ batch_clients/                    â†’ Batch configuration for an end client (monthly invoicing)
â”œâ”€â”€ CONTRATS/                         â†’ Legal documents related to the service
â”‚
â”œâ”€â”€ LICENCE.md                        â†’ Conditions dâ€™utilisation et cadre lÃ©gal (FR)
â”œâ”€â”€ LICENSE.md                        â†’ Terms of use and legal Framework
â”‚
â””â”€â”€ docs/
    â”œâ”€â”€ README_FR.md                  â†’ Documentation gÃ©nÃ©rale du systÃ¨me (FR)
    â”œâ”€â”€ README.md                     â†’ General system documentation
    â”‚
    â”œâ”€â”€ SERVICE_MEMO_FR.md            â†’ Note interne de positionnement du service (FR)
    â”œâ”€â”€ SERVICE_MEMO.md               â†’ Internal Service Positioning Memo
    â”‚
    â”œâ”€â”€ README_DEPLOY_FR.md           â†’ Guide dâ€™installation et dâ€™exploitation (FR)
    â”œâ”€â”€ README_DEPLOY_EN.md           â†’ Installation and Production Guide
    â”‚
    â”œâ”€â”€ VUE_DENSEMBLE_AUTOMATION.md   â†’ Vue dâ€™ensemble du systÃ¨me dâ€™automatisation de facturation (FR)
    â””â”€â”€ SYSTEM_OVERVIEW_AUTOMATION.md â†’ Billing Automation System Overview
```


---

## What this repository is (and is not)

### This repository is

- a documented architecture for financial automation  
- a system designed to be predictable and auditable  
- an example of strict separation between billing, payments, and accounting  
- a real-world system used in production

### This repository is not

- a certified accounting software  
- a ready-to-use invoicing tool  
- a payment processing system  
- a web application or API service

The outputs produced by this system are intended for internal operational use and for integration with standard accounting workflows.

---

## Core design principles

This system follows a small set of non-negotiable principles:  

- **No magic**  
  Every operation is explicit and traceable.

- **No silent processing**  
  Errors stop execution. They are logged and surfaced.

- **No implicit correction**  
  Invalid inputs are rejected, not â€œfixedâ€.

- **Files are proofs**  
  Generated artifacts are considered immutable evidence, not disposable outputs.

- **Strict separation of responsibilities**  
  Billing, payments, balances, receipts, and exports are handled independently.

- **CLI-only execution**  
  No web exposure, no background ambiguity.

These principles favor predictability over convenience and clarity over speed.

The progressive extension of the engine  
did not compromise these principles.

Newly added capabilities  
(multi-line invoices, multiple VAT rates, complex service periods)  
strictly follow the same rules  
of predictability, traceability, and explicit rejection.

---

## System architecture (high-level)

The system is composed of independent layers, each with a single responsibility:  

- **Billing engines**  
  - direct invoicing  
  - batch invoicing (CSV-driven)

- **Business rules**  
  - centralized pricing and billing logic  
  - single source of truth

- **Alerting layer**  
  - blocking vs informational alerts  
  - explicit execution feedback

- **Payment layer**  
  - manual payment records  
  - deliberately decoupled from billing

- **Balance reconciliation**  
  - computed state (invoiced vs paid)  
  - paid / unpaid detection

- **Export layer**  
  - accounting-ready CSV outputs  
  - reproducible at any time

Some layers can evolve independently  
without impacting others,  
allowing the system to be extended  
without global side effects.

---

## Project structure (conceptual view)

The directory layout mirrors the systemâ€™s responsibilities:  

`engine/`        â†’ execution engines & business logic  
`clients/`       â†’ client configuration (one file per client)  
`batch_clients/` â†’ batch client definitions  
`data/`          â†’ immutable operational data (logs, invoices, balances)  
`docs/`          â†’ internal specifications (e.g. CSV format)  
`tools/`         â†’ reconciliation and export utilities  
`exports/`       â†’ generated accounting artifacts  
`downloads/`     â†’ packaged invoice archives


Each directory exists for one reason only.  
Cross-responsibility coupling is intentionally avoided.

---

## Execution model

The system runs on a closed, repeatable cycle:  

1. **Generation phase**  
   Invoices are generated based on explicit rules and configurations.

2. **Payment phase**  
   Payments are recorded independently, without automation or assumptions.

3. **Reconciliation phase**  
   Invoiced amounts are compared against received payments.

4. **Consolidation phase**  
   Client balances are computed and statuses updated.

5. **Export phase**  
   Accounting-ready artifacts are produced on demand.

### Client onboarding tool

`engine/build_json.php` converts onboarding data into the internal  
client configuration used by the automation pipeline.

During processing, the script:  

- generates a unique `client_id`  
- creates the client configuration  
- prepares the batch client definition  
- initializes payment tracking  
- archives the processed onboarding record

This step occurs strictly during the preparation phase and does not  
interfere with the monthly execution cycle.

At no point does the system infer or guess missing information.

---

## Batch invoicing model

In batch mode:  

- one client provides one CSV file  
- one CSV line equals one invoice  
- validation is strict and structural  
- the entire batch stops on the first error  
- raw inputs are archived before consumption

This model favors data integrity over partial success.

The billing model supports complex use cases  
without altering the execution cycle:  

- multi-line invoices  
- multiple VAT rates within a single invoice  
- extended or split service periods  
- multi-month billing scenarios

These capabilities are integrated  
without introducing implicit conditional logic  
or special-case processing outside the engine.

### Entry point â€” client CSV upload

The monthly CSV file is submitted by the client through a dedicated  
upload form, accessible only via an individual secure link provided  
after contract validation.

The entry point:  

- accepts CSV files only  
- provides a downloadable reference CSV template  
- stores the file in the structured `inbox_batch/` directory  
- enforces a single submission per client and period  
- preserves the file for strict downstream validation

The uploaded CSV is treated as a **raw billing data source**  
and is never considered a final invoice.

It is later validated and consumed exclusively by `run_batch.php`  
within the standard batch processing pipeline.

---

## Integrity & safeguards

Several mechanisms are enforced across the system:  

- anti-duplicate protections  
- annual sequential counters  
- immutable archives  
- explicit execution flags  
- categorized alerts  
- exhaustive logging

A failed execution is considered safer than a partial one.

Validation rules remain identical  
regardless of invoice complexity.

A complex case is treated  
with the same requirements as a simple one.

---

## Security posture

- CLI-only execution  
- no exposed endpoints  
- no browser access  
- no external API dependency for core operations  
- data stored locally on the server

Security is achieved through absence of surface, not complexity.

---

## Maintenance & longevity

The system is designed to:  

- be understandable without its original author  
- be auditable months or years later  
- degrade loudly rather than silently  
- integrate cleanly with standard accounting processes

This repository documents an engineering approach, not a shortcut.

---

## Project status

Status: Stable â€” used in real production conditions.

The system has been designed to operate autonomously,  
with a strong emphasis on rigor, traceability, and long-term maintainability.

---

Â© Palks Studio â€” see LICENSE.md  
https://palks-studio.com
